<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lebaoxun.modules.fastfood.dao.FoodOrderDao">

    <resultMap type="com.lebaoxun.modules.fastfood.entity.FoodOrderEntity" id="foodOrderMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="userId" column="user_id"/>
        <result property="payType" column="pay_type"/>
        <result property="orderStatus" column="order_status"/>
        <result property="orderAmount" column="order_amount"/>
        <result property="redPackedAmount" column="red_packed_amount"/>
        <result property="orderScore" column="order_score"/>
        <result property="payAmount" column="pay_amount"/>
        <result property="buyNumber" column="buy_number"/>
        <result property="macId" column="mac_id"/>
        <result property="activityId" column="activity_id"/>
        <result property="activityType" column="activity_type"/>
        <result property="activityFee" column="activity_fee"/>
        <result property="couponId" column="coupon_id"/>
        <result property="redPackedId" column="red_packed_id"/>
        <result property="source" column="source"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="takeFoodTime" column="take_food_time"/>
        <result property="couponType" column="coupon_type"/>
        <result property="couponFee" column="coupon_fee"/>
        <result property="qrCode" column="qr_code"/>
        <collection property="childs" resultMap="foodOrderChildsMap" ofType="com.lebaoxun.modules.fastfood.entity.FoodOrderChildsEntity"></collection>
    </resultMap>
    
    <resultMap type="com.lebaoxun.modules.fastfood.entity.FoodOrderChildsEntity" id="foodOrderChildsMap">
        <result property="orderProductId" column="order_product_id"/>
        <result property="orderId" column="order_id"/>
        <result property="productCatId" column="product_cat_id"/>
        <result property="productId" column="product_id"/>
        <result property="price" column="price"/>
        <result property="score" column="score"/>
        <result property="buyNumber" column="buy_number"/>
        <result property="productScore" column="product_score"/>
        <result property="productAmount" column="product_amount"/>
        <result property="status" column="status"/>
    </resultMap>
    
    <insert id="insert" parameterType="com.lebaoxun.modules.fastfood.entity.FoodOrderEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO food_order (
        order_no, user_id,pay_type,order_status,
        order_amount, red_packed_amount, order_score, pay_amount, buy_number,
        mac_id, activity_id, activity_type, coupon_id, red_packed_id,
        source, create_time, update_time, take_food_time, coupon_type, coupon_fee) VALUES
        ( #{orderNo}, #{userId}, #{payType}, #{orderStatus},
        #{orderAmount}, #{redPackedAmount}, #{orderScore}, #{payAmount}, #{buyNumber},
        #{macId}, #{activityId}, #{activityType}, #{couponId}, #{redPackedId},
        #{source}, #{createTime}, #{updateTime}, #{takeFoodTime} ,#{couponType}, #{couponFee});
    </insert>
    
    <resultMap type="java.util.Map" id="foodMacOrderMap">
        <result property="orderAmount" column="orderAmount"/>
        <result property="redPackedAmount" column="redPackedAmount"/>
        <result property="orderScore" column="orderScore"/>
        <result property="payAmount" column="payAmount"/>
        <result property="couponFee" column="couponFee"/>
        <result property="buyNumber" column="buyNumber"/>
        <result property="orderTime" column="orderTime"/>
        <result property="takeFoodTime" column="takeFoodTime"/>
        <result property="orderStatus" column="orderStatus"/>
        <collection property="childs" resultMap="foodMacOrderChildsMap" ofType="java.util.Map"></collection>
    </resultMap>
    
    <resultMap type="java.util.Map" id="foodMacOrderChildsMap">
        <result property="buyNumber" column="childBuyNumber"/>
        <result property="price" column="price"/>
        <result property="costPrice" column="costPrice"/>
        <result property="productName" column="productName"/>
        <result property="x" column="x"/>
        <result property="y" column="y"/>
    </resultMap>

    <!--扫码查询订单信息-->
    <select  id="getSweeptCodeOrderInfo" resultMap="foodMacOrderMap" >
        SELECT
            order_t.order_amount AS orderAmount,
			order_t.red_packed_amount AS redPackedAmount,
			order_t.order_score AS orderScore,
			order_t.pay_amount AS payAmount,
			order_t.coupon_fee AS couponFee,
			order_t.buy_number AS buyNumber,
			order_t.create_time AS orderTime,
			order_t.take_food_time as takeFoodTime,
			order_t.order_status as orderStatus,
	      	child.buy_number as childBuyNumber,
	      	child.price as price,
		  	child.cost_price as costPrice,
	      	child.product_name as productName,
			aisle.x,
	     	aisle.y
        FROM
            food_order order_t
        LEFT JOIN food_order_childs as child ON child.order_id = order_t.id
	    LEFT JOIN food_machine_aisle as aisle on aisle.id = child.aisle_id
        where order_t.order_no=#{orderNo}
    </select>
    
    <select id="findOrderInfoByMacIMEI" resultMap="foodMacOrderMap">
        SELECT
	      	order_t.order_amount AS orderAmount,
	      	order_t.order_no AS orderNo,
			order_t.red_packed_amount AS redPackedAmount,
			order_t.order_score AS orderScore,
			order_t.pay_amount AS payAmount,
			order_t.coupon_fee AS couponFee,
			order_t.buy_number AS buyNumber,
			order_t.create_time AS orderTime,
			order_t.take_food_time as takeFoodTime,
	      	child.buy_number as childBuyNumber,
	      	child.price as price,
		  	child.cost_price as costPrice,
	      	child.product_name as productName,
			aisle.x,
	     	aisle.y
		FROM
			food_order order_t
		LEFT JOIN food_order_childs as child ON child.order_id = order_t.id
	    LEFT JOIN food_machine_aisle as aisle on aisle.id = child.aisle_id
		where 
		order_t.order_status = 1
		and order_t.mac_id= (select id from food_machine where IMEI = #{imei})
    </select>
    
    <select id="findOrderByUser" resultMap="foodOrderMap" >
		select * from food_order as t1
		left join food_order_childs as t2 on t2.order_id = t1.id
		where t1.user_id = #{userId}
		<if test="status != null">
		 and t1.order_status = #{status}
		</if>
		order by t1.create_time desc
		<if test="size != null">
			limit
			<if test="offset != null">
				#{offset,jdbcType=INTEGER},
			</if>
			#{size,jdbcType=INTEGER}
		</if>
    </select>
    
    <select id="findOrderInfoByUser" resultMap="foodOrderMap">
        select * from food_order as t1
		left join food_order_childs as t2 on t2.order_id = t1.id
		where t1.user_id = #{userId} and order_no = #{orderNo}
    </select>
</mapper>