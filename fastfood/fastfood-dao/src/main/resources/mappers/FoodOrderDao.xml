<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lebaoxun.modules.fastfood.dao.FoodOrderDao">

    <resultMap type="com.lebaoxun.modules.fastfood.entity.FoodOrderEntity" id="foodOrderMap">
        <result property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="userId" column="user_id"/>
        <result property="payType" column="pay_type"/>
        <result property="orderStatus" column="order_status"/>
        <result property="orderAmount" column="order_amount"/>
        <result property="redPackedAmount" column="red_packed_amount"/>
        <result property="orderScore" column="order_score"/>
        <result property="payAmount" column="pay_amount"/>
        <result property="buyNumber" column="buy_number"/>
        <result property="macId" column="mac_id"/>
        <result property="activityId" column="activity_id"/>
        <result property="activityType" column="activity_type"/>
        <result property="activityFee" column="activity_fee"/>
        <result property="couponId" column="coupon_id"/>
        <result property="redPackedId" column="red_packed_id"/>
        <result property="source" column="source"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="takeFoodTime" column="take_food_time"/>
        <result property="couponType" column="coupon_type"/>
        <result property="couponFee" column="coupon_fee"/>
        
        <collection property="childs" resultMap="foodOrderChildsMap" ofType="com.lebaoxun.modules.fastfood.entity.FoodOrderChildsEntity"></collection>
    </resultMap>
    
    <resultMap type="com.lebaoxun.modules.fastfood.entity.FoodOrderChildsEntity" id="foodOrderChildsMap">
        <result property="orderProductId" column="order_product_id"/>
        <result property="orderId" column="order_id"/>
        <result property="productCatId" column="product_cat_id"/>
        <result property="productId" column="product_id"/>
        <result property="price" column="price"/>
        <result property="score" column="score"/>
        <result property="buyNumber" column="buy_number"/>
        <result property="productScore" column="product_score"/>
        <result property="productAmount" column="product_amount"/>
        <result property="status" column="status"/>
    </resultMap>

    <insert id="insert" parameterType="com.lebaoxun.modules.fastfood.entity.FoodOrderEntity"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO food_order (
        order_no, user_id,pay_type,order_status,
        order_amount, red_packed_amount, order_score, pay_amount, buy_number,
        mac_id, activity_id, activity_type, coupon_id, red_packed_id,
        source, create_time, update_time, take_food_time, coupon_type, coupon_fee) VALUES
        ( #{orderNo}, #{userId}, #{payType}, #{orderStatus},
        #{orderAmount}, #{redPackedAmount}, #{orderScore}, #{payAmount}, #{buyNumber},
        #{macId}, #{activityId}, #{activityType}, #{couponId}, #{redPackedId},
        #{source}, #{createTime}, #{updateTime}, #{takeFoodTime} ,#{couponType}, #{couponFee});
    </insert>


    <!--扫码查询订单信息-->
    <select  id="getSweeptCodeOrderInfo" resultType="java.util.Map">
        SELECT
            order_t.id AS orderId,
            order_t.order_no AS orderNo,
            order_t.user_id AS userId,
            order_t.pay_type AS payType,
            order_t.order_amount AS orderAmount,
            order_t.red_packed_amount AS redPackedAmount,
            order_t.order_score AS orderScore,
            order_t.pay_amount AS payAmount,
            order_t.coupon_fee AS couponFee,
            order_t.activity_id AS activityId,
            act. NAME AS activityName,
            order_t.coupon_id AS couponId,
            order_t.coupon_type AS couponType,
            coupon.`name` AS couponName,
            order_t.red_packed_id AS redPackedId,
            order_t.buy_number AS buyNumber,
            order_t.create_time AS orderTime
        FROM
            food_order order_t
        LEFT JOIN operate_coupon coupon ON order_t.coupon_id = coupon.id
        LEFT JOIN (
            SELECT
                1 activity_type,
                NAME,
                `use`
            FROM
                operate_activity_first_order
            UNION ALL
                SELECT
                    2 activity_type,
                    NAME,
                    `use`
                FROM
                    operate_activity_keep_discount
                UNION ALL
                    SELECT
                        3 activity_type,
                        NAME,
                        `use`
                    FROM
                        operate_activity_pay_cash_back
        ) act ON order_t.activity_type = act.activity_type
        where order_t.id=#{orderId}
    </select>
    
    <select id="findOrderInfoByMacIMEI" resultType="java.util.Map">
    	SELECT
            order_t.id AS orderId,
            order_t.order_no AS orderNo,
            order_t.user_id AS userId,
            order_t.pay_type AS payType,
            order_t.order_amount AS orderAmount,
            order_t.red_packed_amount AS redPackedAmount,
            order_t.order_score AS orderScore,
            order_t.pay_amount AS payAmount,
            order_t.coupon_fee AS couponFee,
            order_t.activity_id AS activityId,
            act. NAME AS activityName,
            order_t.coupon_id AS couponId,
            order_t.coupon_type AS couponType,
            coupon.`name` AS couponName,
            order_t.red_packed_id AS redPackedId,
            order_t.buy_number AS buyNumber,
            order_t.create_time AS orderTime,
            order_t.take_food_time as takeFoodTime
        FROM
            food_order order_t
        LEFT JOIN operate_coupon coupon ON order_t.coupon_id = coupon.id
        LEFT JOIN (
            SELECT
                1 activity_type,
                NAME,
                `use`
            FROM
                operate_activity_first_order
            UNION ALL
                SELECT
                    2 activity_type,
                    NAME,
                    `use`
                FROM
                    operate_activity_keep_discount
                UNION ALL
                    SELECT
                        3 activity_type,
                        NAME,
                        `use`
                    FROM
                        operate_activity_pay_cash_back
        ) act ON order_t.activity_type = act.activity_type
        where 
        order_t.order_status = 1
        and order_t.mac_id= (select id from food_machine where IMEI = #{imei})
    </select>
    
    <select id="findOrderByUser" resultMap="foodOrderMap" >
		select * from food_order as t1
		left join food_order_childs as t2 on t2.order_id = t1.id
		where t1.user_id = #{userId}
		<if test="status != null">
		 and t1.order_status = #{status}
		</if>
		order by t1.create_time desc
		<if test="size != null">
			limit
			<if test="offset != null">
				#{offset,jdbcType=INTEGER},
			</if>
			#{size,jdbcType=INTEGER}
		</if>
    </select>
    
    <select id="findOrderInfoByUser" resultMap="foodOrderMap">
        select * from food_order as t1
		left join food_order_childs as t2 on t2.order_id = t1.id
		where t1.user_id = #{userId} and order_no = #{orderNo}
    </select>
</mapper>